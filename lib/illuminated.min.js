(function(a){function t(b,d,c){var f=t.epsilon||1E-6,e,g=[];"object"===typeof b&&"number"===typeof d&&(d=b);"number"===typeof d?(e=d,d=e*e+c*c):(e=d.x,c=d.y,d=d.length2());var h=c*Math.sqrt(d-b*b),k=Math.acos((-b*e+h)/d),m=Math.acos((-b*e-h)/d);d=b*Math.cos(k);var k=b*Math.sin(k),h=b*Math.cos(m),l=b*Math.sin(m);b=new a.Vec2(e+h,c+l);g.push(b);m=b.length2();b=new a.Vec2(e+d,c-k);g.push(b);var n=b.length2();if(Math.abs(m-n)<f)return g;b=new a.Vec2(e+h,c-l);g.push(b);h=b.length2();if(Math.abs(n-h)<f)return[b,
g[1]];if(Math.abs(m-h)<f)return[g[0],b];b=new a.Vec2(e+d,c+k);g.push(b);e=b.length2();return Math.abs(h-e)<f?[g[2],b]:Math.abs(n-e)<f?[g[1],b]:Math.abs(m-e)<f?[g[0],b]:g}function p(b,d,a){var f="illujs_"+b;b=document.getElementById(f);null===b&&(b=document.createElement("canvas"),b.id=f,b.width=d,b.height=a,b.style.display="none",document.body.appendChild(b));f=b.getContext("2d");f.clearRect(0,0,b.width,b.height);b.width=d;b.height=a;return{canvas:b,ctx:f,w:d,h:a}}function r(b,a,c){var f=a[0];b.moveTo(f.x,
f.y);for(var e=1,g=a.length;e<g;++e)f=a[e],b.lineTo(f.x,f.y);!c&&2<a.length&&(f=a[0],b.lineTo(f.x,f.y))}function n(b){for(var a=1,c=arguments.length;a<c;++a){var f=arguments[a];if(f)for(var e in f)void 0!==f[e]&&(b[e]=f[e])}}function u(){}function q(b,a){u.prototype=a.prototype;b.prototype=new u;b.prototype.constructor=b;b.prototype.__super=a.prototype}a.Vec2=function(b,a){this.x=b||0;this.y=a||0};a.Vec2.prototype.copy=function(){return new a.Vec2(this.x,this.y)};a.Vec2.prototype.dot=function(b){return b.x*
this.x+b.y*this.y};a.Vec2.prototype.sub=function(b){return new a.Vec2(this.x-b.x,this.y-b.y)};a.Vec2.prototype.add=function(b){return new a.Vec2(this.x+b.x,this.y+b.y)};a.Vec2.prototype.mul=function(b){return new a.Vec2(this.x*b,this.y*b)};a.Vec2.prototype.inv=function(){return this.mul(-1)};a.Vec2.prototype.dist2=function(b){var a=this.x-b.x;b=this.y-b.y;return a*a+b*b};a.Vec2.prototype.normalize=function(){var b=Math.sqrt(this.length2());return new a.Vec2(this.x/b,this.y/b)};a.Vec2.prototype.length2=
function(b){return this.x*this.x+this.y*this.y};a.Vec2.prototype.toString=function(){return this.x+","+this.y};a.Vec2.prototype.inBound=function(b,a){return b.x<this.x&&this.x<a.x&&b.y<this.y&&this.y<a.y};a.Light=function(b){n(this,a.Light.defaults,b)};a.Light.defaults={position:new a.Vec2,distance:100,diffuse:.8};a.Light.prototype.render=function(b){};a.Light.prototype.mask=function(b){var a=this._getVisibleMaskCache();b.drawImage(a.canvas,Math.round(this.position.x-a.w/2),Math.round(this.position.y-
a.h/2))};a.Light.prototype.bounds=function(){return{topleft:new a.Vec2(this.position.x-this.distance,this.position.y-this.distance),bottomright:new a.Vec2(this.position.x+this.distance,this.position.y+this.distance)}};a.Light.prototype.center=function(){return new a.Vec2(this.distance,this.distance)};a.Light.prototype.forEachSample=function(b){b(this.position)};a.Light.prototype._getVisibleMaskCache=function(){var b=Math.floor(1.4*this.distance),a=""+b;this.vismaskhash!=a&&(this.vismaskhash=a,a=this._vismaskcache=
p("vm"+this.id,2*b,2*b),b=a.ctx.createRadialGradient(b,b,0,b,b,b),b.addColorStop(0,"rgba(0,0,0,1)"),b.addColorStop(1,"rgba(0,0,0,0)"),a.ctx.fillStyle=b,a.ctx.fillRect(0,0,a.w,a.h));return this._vismaskcache};a.Light.prototype._getHashCache=function(){return[this.distance,this.diffuse].toString()};a.OpaqueObject=function(b){n(this,a.OpaqueObject.defaults,b)};a.OpaqueObject.defaults={diffuse:.8};a.OpaqueObject.uniqueId=0;a.OpaqueObject.prototype.cast=function(b,a,c){};a.OpaqueObject.prototype.path=
function(b){};a.OpaqueObject.prototype.bounds=function(){return{topleft:new a.Vec2,bottomright:new a.Vec2}};a.OpaqueObject.prototype.contains=function(b){return!1};a.Lamp=function(b){n(this,a.Light.defaults,a.Lamp.defaults,b);0===this.id&&(this.id=++a.Lamp.uniqueId)};q(a.Lamp,a.Light);a.Lamp.defaults={id:0,color:"rgba(250,220,150,0.8)",radius:0,samples:1,angle:0,roughness:0};a.Lamp.uniqueId=0;a.Lamp.prototype._getHashCache=function(){return[this.color,this.distance,this.diffuse,this.angle,this.roughness,
this.samples,this.radius].toString()};a.Lamp.prototype.center=function(){return new a.Vec2((1-Math.cos(this.angle)*this.roughness)*this.distance,(1+Math.sin(this.angle)*this.roughness)*this.distance)};a.Light.prototype.bounds=function(){var b=(new a.Vec2(Math.cos(this.angle),-Math.sin(this.angle))).mul(this.roughness*this.distance);return{topleft:new a.Vec2(this.position.x+b.x-this.distance,this.position.y+b.y-this.distance),bottomright:new a.Vec2(this.position.x+b.x+this.distance,this.position.y+
b.y+this.distance)}};a.Lamp.prototype.mask=function(b){var d=this._getVisibleMaskCache(),c=(new a.Vec2(Math.cos(this.angle),-Math.sin(this.angle))).mul(this.roughness*this.distance);b.drawImage(d.canvas,Math.round(this.position.x+c.x-d.w/2),Math.round(this.position.y+c.y-d.h/2))};a.Lamp.prototype._getGradientCache=function(b){var d=this._getHashCache();if(this._cacheHashcode==d)return this._gcache;this._cacheHashcode=d;var d=Math.round(this.distance),c=2*d,c=p("gc"+this.id,c,c);b=c.ctx.createRadialGradient(b.x,
b.y,0,d,d,d);b.addColorStop(Math.min(1,this.radius/this.distance),this.color);b.addColorStop(1,a.getRGBA(this.color,0));c.ctx.fillStyle=b;c.ctx.fillRect(0,0,c.w,c.h);return this._gcache=c};a.Lamp.prototype.render=function(b){var a=this.center(),c=this._getGradientCache(a);b.drawImage(c.canvas,Math.round(this.position.x-a.x),Math.round(this.position.y-a.y))};a.Lamp.prototype.forEachSample=function(b){for(var d=0,c=this.samples;d<c;++d){var f=d*v,e=Math.sqrt(d/this.samples)*this.radius,f=new a.Vec2(Math.cos(f)*
e,Math.sin(f)*e);b(this.position.add(f))}};a.DiscObject=function(b){n(this,a.OpaqueObject.defaults,a.DiscObject.defaults,b)};q(a.DiscObject,a.OpaqueObject);a.DiscObject.defaults={center:new a.Vec2,radius:20};a.DiscObject.prototype.cast=function(b,a,c){var f=this.center,e=f.sub(a),g=t(this.radius,e),h=g[0],k=g[1],g=h.add(a);a=k.add(a);c=(c.bottomright.x-c.topleft.x+(c.bottomright.y-c.topleft.y))/2;e=e.normalize().mul(c);h=h.normalize().mul(c);k=k.normalize().mul(c);c=g.add(e);var m=a.add(e),h=g.add(h),
k=a.add(k),e=Math.atan2(e.x,-e.y);b.beginPath();r(b,[a,k,m,c,h,g],!0);b.arc(f.x,f.y,this.radius,e,e+Math.PI);b.fill()};a.DiscObject.prototype.path=function(b){b.arc(this.center.x,this.center.y,this.radius,0,w)};a.DiscObject.prototype.bounds=function(){return{topleft:new a.Vec2(this.center.x-this.radius,this.center.y-this.radius),bottomright:new a.Vec2(this.center.x+this.radius,this.center.y+this.radius)}};a.DiscObject.prototype.contains=function(b){return b.dist2(this.center)<this.radius*this.radius};
a.PolygonObject=function(b){n(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,b)};q(a.PolygonObject,a.OpaqueObject);a.PolygonObject.defaults={points:[]};a.PolygonObject.prototype.bounds=function(){for(var b=this.points[0].copy(),a=b.copy(),c=1,f=this.points.length;c<f;++c){var e=this.points[c];e.x>a.x&&(a.x=e.x);e.y>a.y&&(a.y=e.y);e.x<b.x&&(b.x=e.x);e.y<b.y&&(b.y=e.y)}return{topleft:b,bottomright:a}};a.PolygonObject.prototype.contains=function(b){var a=this.points,c=a.length,f=c-1,e=b.x,g=b.y,
h=!1;for(b=0;b<c;b++)(a[b].y<g&&a[f].y>=g||a[f].y<g&&a[b].y>=g)&&(a[b].x<=e||a[f].x<=e)&&a[b].x+(g-a[b].y)/(a[f].y-a[b].y)*(a[f].x-a[b].x)<e&&(h=!h),f=b;return h};a.PolygonObject.prototype.path=function(a){r(a,this.points)};a.PolygonObject.prototype.cast=function(a,d,c){var f=(c.bottomright.x-c.topleft.x+(c.bottomright.y-c.topleft.y))/2;this._forEachVisibleEdges(d,c,function(c,g,h,k,m){var l=h.inv().dot(m)/m.length2(),l=(0>l?c:1<l?g:c.add(m.mul(l))).sub(d),l=l.normalize().mul(f);h=h.normalize().mul(f);
k=k.normalize().mul(f);m=c.add(l);l=g.add(l);h=c.add(h);k=g.add(k);a.beginPath();r(a,[c,g,k,l,m,h]);a.fill()})};a.PolygonObject.prototype._forEachVisibleEdges=function(b,d,c){for(var f=this.points[this.points.length-1],e,g=0,h=this.points.length;g<h;++g,f=e)if(e=this.points[g],f.inBound(d.topleft,d.bottomright)){var k=f.sub(b),m=e.sub(b),l=e.sub(f);0>(new a.Vec2(l.y,-l.x)).dot(k)&&c(f,e,k,m,l)}};a.RectangleObject=function(b){n(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,a.RectangleObject.defaults,
b);this.syncFromTopleftBottomright()};q(a.RectangleObject,a.PolygonObject);a.RectangleObject.defaults={topleft:new a.Vec2,bottomright:new a.Vec2};a.RectangleObject.prototype.syncFromTopleftBottomright=function(){var b=this.topleft,d=new a.Vec2(this.bottomright.x,this.topleft.y),c=this.bottomright,f=new a.Vec2(this.topleft.x,this.bottomright.y);this.points=[b,d,c,f]};a.RectangleObject.prototype.fill=function(a){var d=this.points[0].x,c=this.points[0].y;a.rect(d,c,this.points[2].x-d,this.points[2].y-
c)};a.LineObject=function(b){n(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,a.LineObject.defaults,b);this.syncFromAB()};q(a.LineObject,a.PolygonObject);a.LineObject.defaults={a:new a.Vec2,b:new a.Vec2};a.LineObject.prototype.syncFromAB=function(){this.points=[this.a,this.b]};a.Lighting=function(b){n(this,a.Lighting.defaults,b)};a.Lighting.defaults={light:new a.Light,objects:[]};a.Lighting.prototype.createCache=function(a,d){this._cache=p("lc",a,d);this._castcache=p("lcc",a,d)};a.Lighting.prototype.cast=
function(a){var d=this.light,c=d.samples,f=this._castcache,e=f.ctx;e.clearRect(0,0,f.w,f.h);e.fillStyle="rgba(0,0,0,"+Math.round(100/c)/100+")";var g=d.bounds(),h=this.objects;d.forEachSample(function(a){for(var b=0,c=h.length;b<c;++b)if(h[b].contains(a)){e.fillRect(g.topleft.x,g.topleft.y,g.bottomright.x-g.topleft.x,g.bottomright.y-g.topleft.y);return}h.forEach(function(b){b.cast(e,a,g)})});h.forEach(function(a){var b=void 0===a.diffuse?.8:a.diffuse,b=b*d.diffuse;e.fillStyle="rgba(0,0,0,"+(1-b)+
")";e.beginPath();a.path(e);e.fill()});a.drawImage(f.canvas,0,0)};a.Lighting.prototype.compute=function(a,d){this._cache&&this._cache.w==a&&this._cache.h==d||this.createCache(a,d);var c=this._cache.ctx,f=this.light;c.save();c.clearRect(0,0,c.canvas.width,c.canvas.height);f.render(c);c.globalCompositeOperation="destination-out";this.cast(c);c.restore()};a.Lighting.prototype.render=function(a){a.drawImage(this._cache.canvas,0,0)};a.Lighting.prototype.getCanvas=function(){return this._cache.canvas};
a.DarkMask=function(b){n(this,a.DarkMask.defaults,b)};a.DarkMask.defaults={lights:[],color:"rgba(0,0,0,0.9)"};a.DarkMask.prototype.compute=function(a,d){this._cache&&this._cache.w==a&&this._cache.h==d||(this._cache=p("dm",a,d));var c=this._cache.ctx;c.save();c.clearRect(0,0,a,d);c.fillStyle=this.color;c.fillRect(0,0,a,d);c.globalCompositeOperation="destination-out";this.lights.forEach(function(a){a.mask(c)});c.restore()};a.DarkMask.prototype.render=function(a){a.drawImage(this._cache.canvas,0,0)};
a.DarkMask.prototype.getCanvas=function(a){return this._cache.canvas};var v=Math.PI*(3-Math.sqrt(5)),w=2*Math.PI;a.createCanvasAnd2dContext=p;a.path=r;a.getRGBA=function(){var a=document.createElement("canvas");a.width=a.height=1;var d=a.getContext("2d");return function(a,b){d.clearRect(0,0,1,1);d.fillStyle=a;d.fillRect(0,0,1,1);var e=d.getImageData(0,0,1,1).data;return"rgba("+[e[0],e[1],e[2],b]+")"}}();a.extractColorAndAlpha=function(){function a(b){b=b.toString(16);1==b.length&&(b="0"+b);return b}
var d=document.createElement("canvas");d.width=d.height=1;var c=d.getContext("2d");return function(d){c.clearRect(0,0,1,1);c.fillStyle=d;c.fillRect(0,0,1,1);d=c.getImageData(0,0,1,1).data;return{color:"#"+a(d[0])+a(d[1])+a(d[2]),alpha:Math.round(1E3*d[3]/255)/1E3}}}();a.extend=n;a.inherit=q})(window.illuminated={});
